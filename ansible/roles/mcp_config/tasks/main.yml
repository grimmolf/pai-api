---
# MCP Configuration tasks

- name: Ensure .gemini directory exists
  ansible.builtin.file:
    path: "{{ ansible_user_dir }}/.gemini"
    state: directory
    owner: "{{ ansible_user_id }}"
    mode: '0755'

- name: Check if Gemini settings.json exists
  ansible.builtin.stat:
    path: "{{ ansible_user_dir }}/.gemini/settings.json"
  register: gemini_settings_stat

- name: Backup existing Gemini settings
  ansible.builtin.copy:
    src: "{{ ansible_user_dir }}/.gemini/settings.json"
    dest: "{{ ansible_user_dir }}/.gemini/settings.json.backup"
    remote_src: yes
  when: gemini_settings_stat.stat.exists

- name: Read existing Gemini settings
  ansible.builtin.slurp:
    src: "{{ ansible_user_dir }}/.gemini/settings.json"
  register: existing_gemini_config
  when: gemini_settings_stat.stat.exists

- name: Parse existing Gemini settings
  ansible.builtin.set_fact:
    gemini_config: "{{ (existing_gemini_config.content | b64decode | from_json) if gemini_settings_stat.stat.exists else {} }}"

- name: Merge MCP server into Gemini config
  ansible.builtin.set_fact:
    gemini_config: "{{ gemini_config | combine({'mcpServers': gemini_config.mcpServers | default({}) | combine({mcp_server_name: {'command': deploy_dir + '/run_mcp.fish', 'args': [], 'timeout': mcp_timeout, 'description': mcp_server_description}})}, recursive=True) }}"

- name: Write updated Gemini settings
  ansible.builtin.copy:
    content: "{{ gemini_config | to_nice_json }}"
    dest: "{{ ansible_user_dir }}/.gemini/settings.json"
    owner: "{{ ansible_user_id }}"
    mode: '0644'

- name: Ensure .cursor directory exists
  ansible.builtin.file:
    path: "{{ ansible_user_dir }}/.cursor"
    state: directory
    owner: "{{ ansible_user_id }}"
    mode: '0755'

- name: Check if global Cursor MCP config exists
  ansible.builtin.stat:
    path: "{{ ansible_user_dir }}/.cursor/mcp.json"
  register: cursor_global_config_stat

- name: Read existing Cursor config
  ansible.builtin.slurp:
    src: "{{ ansible_user_dir }}/.cursor/mcp.json"
  register: existing_cursor_config
  when: cursor_global_config_stat.stat.exists

- name: Parse existing Cursor config
  ansible.builtin.set_fact:
    cursor_config: "{{ (existing_cursor_config.content | b64decode | from_json) if cursor_global_config_stat.stat.exists else {'mcpServers': {}} }}"

- name: Merge pai-api into Cursor MCP servers
  ansible.builtin.set_fact:
    cursor_config: "{{ cursor_config | combine({'mcpServers': cursor_config.mcpServers | default({}) | combine({mcp_server_name: {'command': deploy_dir + '/run_mcp.fish', 'args': []}})}, recursive=True) }}"

- name: Write updated Cursor global config
  ansible.builtin.copy:
    content: "{{ cursor_config | to_nice_json }}"
    dest: "{{ ansible_user_dir }}/.cursor/mcp.json"
    owner: "{{ ansible_user_id }}"
    mode: '0644'

- name: Check if Claude Code config exists
  ansible.builtin.stat:
    path: "{{ ansible_user_dir }}/.claude.json"
  register: claude_config_stat

- name: Read existing Claude Code config
  ansible.builtin.slurp:
    src: "{{ ansible_user_dir }}/.claude.json"
  register: existing_claude_config
  when: claude_config_stat.stat.exists

- name: Parse existing Claude Code config
  ansible.builtin.set_fact:
    claude_config: "{{ (existing_claude_config.content | b64decode | from_json) if claude_config_stat.stat.exists else {} }}"

- name: Add pai-api to Claude Code MCP servers
  ansible.builtin.set_fact:
    claude_config: "{{ claude_config | combine({'mcpServers': claude_config.mcpServers | default({}) | combine({mcp_server_name: {'command': deploy_dir + '/run_mcp.fish', 'args': []}})}, recursive=True) }}"
  when: claude_config_stat.stat.exists

- name: Write updated Claude Code config
  ansible.builtin.copy:
    content: "{{ claude_config | to_nice_json }}"
    dest: "{{ ansible_user_dir }}/.claude.json"
    owner: "{{ ansible_user_id }}"
    mode: '0644'
  when: claude_config_stat.stat.exists

- name: Display MCP configuration status
  ansible.builtin.debug:
    msg:
      - "MCP Configuration Complete:"
      - "  Gemini CLI: {{ ansible_user_dir }}/.gemini/settings.json"
      - "  Cursor IDE: {{ ansible_user_dir }}/.cursor/mcp.json"
      - "  Claude Code: {{ 'Configured' if claude_config_stat.stat.exists else 'Not installed - skipped' }}"
